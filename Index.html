<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>SharePoint QR Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; }
    input { padding: 8px; width: 300px; }
    button { padding: 8px 12px; margin-left: 5px; }
    #qr-container { margin-top: 20px; }
    svg { width: 180px; height: 180px; }
  </style>
</head>
<body>

  <h2>SharePoint QR Generator</h2>

  <input type="text" id="docId" placeholder="Enter Document ID" />
  <button onclick="generateQR()">Generate QR</button>
  <button onclick="downloadSVG()">Download SVG</button>

  <div id="qr-container"></div>
  
<script>
  let currentSVG = "";

  function buildVisioQrSvg(qr, cellSize = 6, marginCells = 4) {
    const n = qr.getModuleCount();                 // modules per side
    const size = (n + marginCells * 2) * cellSize; // total px

    // Start SVG with explicit viewport + overflow visible to avoid clipping in importers
    let svg = `<?xml version="1.0" encoding="UTF-8"?>\n` +
      `<svg xmlns="http://www.w3.org/2000/svg" ` +
      `width="${size}px" height="${size}px" ` +
      `viewBox="0 0 ${size} ${size}" ` +
      `preserveAspectRatio="xMidYMid meet" ` +
      `shape-rendering="crispEdges" overflow="visible">\n`;

    // White background (helps Visio treat it as a solid graphic)
    svg += `  <rect x="0" y="0" width="${size}" height="${size}" fill="#ffffff"/>\n`;

    // Draw dark modules
    const offset = marginCells * cellSize;
    svg += `  <g fill="#000000">\n`;
    for (let r = 0; r < n; r++) {
      for (let c = 0; c < n; c++) {
        if (qr.isDark(r, c)) {
          const x = offset + c * cellSize;
          const y = offset + r * cellSize;
          svg += `    <rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}"/>\n`;
        }
      }
    }
    svg += `  </g>\n</svg>\n`;
    return svg;
  }

  function generateQR() {
    const docId = document.getElementById("docId").value.trim();
    if (!docId) { alert("Please enter a Document ID"); return; }

    const baseUrl = "https://leidoscorpuk.sharepoint.com/sites/Saturn/Shared%20Documents/Forms/AllItems.aspx?q=";
    const searchQuery = "DlcDocId%3A" + encodeURIComponent(docId) + "&view=7";
    const finalUrl = baseUrl + searchQuery;

    const qr = qrcode(0, "L");
    qr.addData(finalUrl);
    qr.make();

    // Use a real quiet zone for reliability (Visio-safe + better scanning)
    currentSVG = buildVisioQrSvg(qr, /*cellSize*/ 6, /*marginCells*/ 4);

    document.getElementById("qr-container").innerHTML = currentSVG;
  }

  function downloadSVG() {
    if (!currentSVG) { alert("Generate a QR code first."); return; }
    const blob = new Blob([currentSVG], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "sharepoint-qr.svg";
    a.click();
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
